.PHONY: help install install-ta-lib dev test run start stop clean logs logs-api clean-all format type-check

help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘          NOFX US Stock Trading System - å‘½ä»¤åˆ—è¡¨                  â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ“¦ å®‰è£…ä¸ä¾èµ–:"
	@echo "  make install          # å®‰è£…Pythonä¾èµ– (Poetry)"
	@echo "  make install-ta-lib   # å®‰è£…TA-LibæŠ€æœ¯æŒ‡æ ‡åº“ (å¿…é¡»å…ˆè£…)"
	@echo "  make dev              # å®‰è£…å¼€å‘ä¾èµ–"
	@echo ""
	@echo "ğŸš€ è¿è¡Œç³»ç»Ÿ:"
	@echo "  make run              # å¯åŠ¨åç«¯ (å¼€å‘æ¨¡å¼)"
	@echo "  make start            # å¯åŠ¨åç«¯ (åå°æ¨¡å¼)"
	@echo "  make stop             # åœæ­¢åç«¯"
	@echo ""
	@echo "ğŸ§ª æµ‹è¯•:"
	@echo "  make test             # è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make test-api         # æµ‹è¯•Dummy API"
	@echo ""
	@echo "ğŸ“Š æ—¥å¿—:"
	@echo "  make logs             # å®æ—¶æŸ¥çœ‹æ—¥å¿—"
	@echo "  make logs-api         # æŸ¥çœ‹APIæ—¥å¿—"
	@echo ""
	@echo "ğŸ§¹ æ¸…ç†:"
	@echo "  make clean            # æ¸…ç†ç¼“å­˜å’Œæ—¥å¿—"
	@echo "  make clean-all        # å®Œå…¨æ¸…ç† (åŒ…æ‹¬Poetryç¯å¢ƒ)"
	@echo ""

install:
	@echo "ğŸ“¦ æ­£åœ¨ä½¿ç”¨Poetryå®‰è£…ä¾èµ–..."
	poetry install
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆï¼"

install-ta-lib:
	@echo "ğŸ“Š æ­£åœ¨å®‰è£…TA-Lib..."
	@echo "âš ï¸  è¯·å…ˆå®‰è£…ç³»ç»Ÿä¾èµ–:"
	@echo "  macOS:   brew install ta-lib"
	@echo "  Ubuntu:  sudo apt-get install libta-lib0-dev"
	@echo "  ç„¶åç»§ç»­å®‰è£…Pythonç»‘å®š..."
	@read -p "æ˜¯å¦å·²å®‰è£…ç³»ç»Ÿä¾èµ–ï¼Ÿ(y/n) " confirm && [ $$confirm = "y" ]
	poetry add TA-Lib
	@echo "âœ… TA-Libå®‰è£…å®Œæˆï¼"

dev: install
	@echo "ğŸ”§ å®‰è£…å¼€å‘å·¥å…·..."
	poetry install --with dev
	@echo "âœ… å¼€å‘ç¯å¢ƒé…ç½®å®Œæˆï¼"

test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	poetry run pytest tests/ -v
	@echo "âœ… æµ‹è¯•å®Œæˆï¼"

test-api:
	@echo "ğŸ§ª æµ‹è¯•Dummy Data API..."
	poetry run pytest tests/test_dummy_api.py -v
	@echo "âœ… Dummy APIæµ‹è¯•å®Œæˆï¼"

run:
	@echo "ğŸš€ å¯åŠ¨NOFX US Stockäº¤æ˜“ç³»ç»Ÿ (å¼€å‘æ¨¡å¼)..."
	@echo "âš ï¸  æŒ‰ Ctrl+C åœæ­¢"
	poetry run python src/main.py

start:
	@echo "ğŸš€ å¯åŠ¨NOFX US Stockäº¤æ˜“ç³»ç»Ÿ (åå°æ¨¡å¼)..."
	poetry run python src/main.py > logs/system.log 2>&1 &
	@echo $$! > logs/pid.txt
	@echo "âœ… ç³»ç»Ÿå·²å¯åŠ¨ (PID: $$(cat logs/pid.txt))"
	@echo "ğŸ“Š æ—¥å¿—ä½ç½®: logs/system.log"

stop:
	@echo "â¹ï¸  åœæ­¢ç³»ç»Ÿ..."
	@if [ -f logs/pid.txt ]; then \
		kill $$(cat logs/pid.txt); \
		rm logs/pid.txt; \
		echo "âœ… ç³»ç»Ÿå·²åœæ­¢"; \
	else \
		echo "âš ï¸  ç³»ç»Ÿæœªè¿è¡Œ"; \
	fi

logs:
	@echo "ğŸ“Š å®æ—¶æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿— (æŒ‰ Ctrl+C é€€å‡º)..."
	@if [ -f logs/system.log ]; then \
		tail -f logs/system.log; \
	else \
		echo "âš ï¸  æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"; \
	fi

logs-api:
	@echo "ğŸ“Š æŸ¥çœ‹APIæ—¥å¿—..."
	poetry run python -c "import os; os.makedirs('logs', exist_ok=True)"

clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼“å­˜å’Œæ—¥å¿—..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	rm -rf .pytest_cache
	@echo "âœ… æ¸…ç†å®Œæˆï¼"

clean-all: clean stop
	@echo "ğŸ—‘ï¸  å®Œå…¨æ¸…ç†Poetryç¯å¢ƒ..."
	poetry env remove python 2>/dev/null || true
	@echo "âœ… å®Œå…¨æ¸…ç†å®Œæˆï¼"

format:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	poetry run black src/ tests/
	poetry run isort src/ tests/
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆï¼"

type-check:
	@echo "ğŸ” è¿è¡Œç±»å‹æ£€æŸ¥..."
	poetry run mypy src/
	@echo "âœ… ç±»å‹æ£€æŸ¥å®Œæˆï¼"


